---
filename: _posts/blog/2012-10-29-Running-a-marathon.md
category: blog
layout: post
title: Running a marathon
published: true
tags:
- 
---

[Map]

Last week I ran my first Marathon, the 2012 [Marine Corps Marathon](http://www.marinemarathon.com/). It was my first marathon and it was a **great experience**. I did it 3h54m17s, much better than I expected. To get to that point I trained hard, I changed my diet and my stride, I read papers on strategies, and I *geeked* with the data. I want to talk about all that.
<!--more-->


I can proudly say that the marathon was a challenge, but not a suffering. I did the last mile with a smile on my face and a strong 15 seconds full sprint to the finish line. Two days later I barely have soreness in the legs, and none of the [usual problems](http://walking.about.com/od/marathontraining/tp/marathoninjury.htm): my toe nails are intact, no blisters, injuries, chaffing or particular pain. I base this success in 4 things: Stride, Fitness, Nutrition, Motivation.

###1. Stride

"Every year as many as eighty percent of runners suffer an injury that will keep them off the streets for a month", quotes [Christopher McDougall](http://www.amazon.com/Born-Run-Hidden-Superathletes-Greatest/dp/0307279189). It does't make much sense to me. Running should be natural, why do we get so many injuries? These kind of thoughts lead me to try cold turkey the Vibram [Fivefingers](http://www.vibramfivefingers.com/index.htm). I read a couple of articles, I followed a couple of thread and that was enough for me to try the **front food landing stride**

<img width="40%" src="/media/MCM-stride.png " class="center">

The key points to me were:

* The [running man hypothesis](http://en.wikipedia.org/wiki/Endurance_running_hypothesis) makes sense to me.
* I've seen and stretched an Aquiles tendon when on a dead body (at the Faculty of Medicine). They really have some elasticity. I can see how part of the landing weight is absorved by the elasticity and released when you push, minimizing the energy to run.
* Landing on the ball of the foot really uses the feet that otherwise are quite passive.
* The posture makes you run standing more straight, landing right above the center of mass, so there is no vector pointing backwards. It's just *pushing back* all the time.
* The posture also make you land already with a slight bend on the knee, minimizing the impact on the knee and hips. 
* Quite literally the absorption of the impact is done by the muscles and tendons, not the bones and articulations.
* It just feels smoother and lighter. 

<a href="http://www.zygotebody.com/#nav=-2.34,35.81,120.37"><img width="50%" src="/media/Aquiles.png " class="center"></a>

The only drawback is that, since we always use running shoes, we´ve never run like that, and muscles and tendons are not prepared. You need to go very slowly or you will injure yourself. At first it will feel awkward and will be hard on your Soleus, Gastrocnemius, Aquiles, soles of the feet and thigh. But it pays back, I really believe this stride contributed to running longer, faster and with less pain or soreness afterwards.

I did not run barefoot like at least one people I saw, or with minimal shoes, like a few as well that I saw, but I would not discard it. As I run, I barely use the heel, so the extra cushioning isn't really involved on my stride. On a few occasions I changed my pace to heel strike to release tension and change the cadence as I felt it.

As a side note. When I finished, after a few minutes, I started to feel the start of cramps on my feet. I removed the shoes and walked on my shocks. It worked immediately, my feet just wanted to get free from the shoes and move around a little bit, just like my legs.

###2. Fitness

Together with the stride, you need to have physical fitness to endure the 26 miles. For that you just need to bank as many miles as possible, without overtraining. I followed a trining plan from Adidas [MiCoach](http://www.adidas.com/us/micoach/), but adjusting it whenever I didn't feel good or I had any problems. Before this training the longest I did was a half marathon in March, and that was my absolute maximum. I felt awful when I finished, much pain in the hips and soreness for several days. In those 100 days, I went for 5 km/week the first week, to 70 km/week 4 weeks before tapering for the race.

{% image weekly-runs.png %}


###3. Nutrition

Since Christmas I decided to try to be vegan. No meat (yes, chicken is also meat), eggs, milk, cheese, honey. Nothing from an animal. I did it mostly for environment reasons, and switched back whenever it was too difficult (e.g. when I went to Rio de Janeiro, they eat meat on everything!). All in all I eat meat roughly once a month. I had gone to the doctor before and 3 months later for blood and physical test. Everything was great, I felt better and lost weight. But my doctor did not approved it. When I told him I was planning to train for a marathon as a vegan, he called me stupid. Literally.

I find more and more reasons to reduce my meat intake as much as I can, but I wasn't sure about running a marathon on plants. After reading some more, and learning about many [ultramarathoners are indeed vegan](http://www.huffingtonpost.com/scott-jurek/ultramarathon-running-diet_b_1587874.html), I decided to try, but monitoring my health. I am not an expert in nutrition so I <a href="http://en.wikipedia.org/wiki/Veganism#Vegan_diet">keep it simple</a>: tons of cereals, many legumes and veggies, some fruit and a bit of olive oil. This is my grocery shopping for a couple of days, 90% from the produce section:

<a href="http://www.flickr.com/photos/nasonurb/8145481393/" title="vegan grocery shopping by brunosan, on Flickr"><img src="http://farm9.staticflickr.com/8326/8145481393_f1443b4fa2.jpg" width="75%" class="center" alt="vegan grocery shopping"></a>

In particular I enjoyed the extra intake of quinoa, beets, nuts... I plan to continue like this. I don't think being vegan makes training for a marathon any harder, perhaps on the contrary. And it makes you be more conscious of what you eat, which is good. And [Mint](https://wwws.mint.com) says no significant impact on my food budget.

###4. Motivation

Probably the first you learn when you train for a marathon is that *commitment* is a big part of it. The training will predate over your life. Forget about going out or drinking the night before a long run. The long run itself will make you wake up early on the weekends and will keep you busy at least half of that day alone. I was making 8 hours of actual running a week. You need to watch what you eat, not to get injured, what to wear, ... My life during the last month or so was pretty much running, sleeping and [working](http://index.gain.org/). 

You really need motivation specially on the first days. Running 40 minutes can get very long those early days. But as you train more and more, you start to enjoy and look forward that feeling of achievement and fitness at the end of the race. After a while, the running itself becomes the reward and, believe me, you really enjoy running. You stop thinking about the time and the steps and you get lost in your thoughts, the music you hear, the nature around you.

What really worked for me those early days was the music I was playing via Pandora, and then later [Spotify](http://www.spotify.com/) (btw this is my [running playlist](http://t.co/PAxTGBhd)). And of course the **mapping**. I was mapping every race with [RunKeeper](http://www.runkeeper.com), and knowing I was going to be able to monitor the track, the speed or the heart rate was a motivation on itself. I even made plans to make tracks of particular paths or shapes, like running the borders of the DC rhomboid. During the long runs I would post the live link so that friends or facility could track it in real time. Knowing someone following my run made me push harder. This is the map of the training runs:

Since November 2011 that I started using RunKeeper, I've logged 1,440 km, roughly 718Km for this marathon training.

I've written before on how to make a map in TileMill with [all your runs as a heatmap](http://brunosan.eu/2012/07/20/a-heatmap-for-all-your-runs-in-runkeeper/). I did it again, this time with the marathon itself in black, for contrast. This is it:

The geek fun continues after the marathon. I got hold of all runners data and started playing around with it. This is the second part:

##How I got the data

**Scrapping the data**

The [official website](http://resultsarchive.active.com/pages/searchform.jsp?rsID=136498) lists the results up to 100 per page, but it won´t allow to download it or get all the pages. Thankfully, just hacking the URL you can request "the first 50.000 results" for the first page. It takes a bit to load, it is indeed a huge table with all the data. This is public information, so I don't see any problem taking the public data and mining it.

**Converting the table into csv**

To convert the HTML table into workable data, I tried several ways, and ended up just selecting all the text in the page via "Select All", "Copy" and then paste it on an Excel Workbook. It takes a minute or so, but it works. Just clean the extra lines and columns, and save it as a csv file. From the 34 Mb of the html or Excel, we go down to a 4 Mb csv file.

**Cleaning and geocoding**

I then used [Google Refine](http://code.google.com/p/google-refine/) to clean the data. In particular I did some *Clustering* to fix misspelled Location names, like "Alexxandria". I also joined the "City" with "State" so that the geolocation would work better. 

One important step for later is the **Geocoding** of the "City, State" column. As mentioned on [this post](http://mapbox.com/geo-for-google-docs/), you can use [Yahoo API](http://developer.yahoo.com/geo/placefinder/) to request the (latitude,longitude) for any location. To geocode your locations with Google Refine, you need to make a new column based on the Location column using the *URL Fetch*, and use the YAHOO geocode Yahoo API:

{% image new-column.png %}

    http://where.yahooapis.com/geocode?q=" + value.replace(/\s+/, " ") + "&appid=[appID]

The "replace" thing is to convert spaces into %20 for the URL (like *New York,NY* into *New%20York,NY*). I minimized the milliseconds of throttling to 1 and still it took a good 15 minutes. 

Then parse the extra column to get the (latitude,longitude) tuples:

    forEach(value.split("<Result>"), v,v.partition("<latitude>")[2].partition("</latitude>")[0] +","+v.partition("<longitude>")[2].partition("</longitude>")[0])[1]

Then just export the data  as csv for the next step, mining the data.

**Mining the data with Python**

To import the data in Python I used:
    import csv
	runner=[]
	f = open('MCM.csv', 'rt')
	try:
	    reader = csv.DictReader(f)
	    for row in reader:
	        runner.append(row)
	finally:
	    f.close()

With this I can get some insights on the Marathon:

* There were 23517 finishers, 
* Runners came from 4274 different Locations.
* 42,5% where women, 57,5% men.
* The most common runner was a male, 38 years old, from Washington DC, finishing in ~4h24m
* The most common woman was ~20 slower than the most common men.

but let's break it down more. You can see my whole [python code here](https://gist.github.com/3996931).

**Histogram of participation by gender**

This histogram shows the distribution of Ages, according to gender: 
<a href="/media/histo_gender.png"><img src="/media/histo_gender.png" onmouseover="this.src='/media/histo_gender_2.png'" onmouseout="this.src='/media/histo_gender.png'" class="center"  width='75%'/></a>

At any age, there is more men than women, except from 25-30. Perhaps women are more physically active then. After that women decline while male participation increases. I wonder if having your first kid is shown here. I can imagine it's hard to train or run when you are pregnant or new mum. According to the statistics the [mean age for first kid in the USA](http://www.nationmaster.com/graph/hea_age_of_wom_at_fir_chi-health-age-women-first-childbirth) is 24, so it is plausible.

Men participation peaks at 40-45, after which the decline is similar for both genders, with always more men. Remarkable than 10% of the participants were above 53, and another 10% below 26. As I will show later, without much difference in the average time to finish. Tell me another sport where this variety of ages can enjoy it side to side. *Running is a natural challenge for humans*.

**Histogram of time by gender**

Now, lets compare finishing times by gender, regardless of age. Men peak around ~4h30m, with another peak just below 4h (me!). Women peak more smoothly around ~4h50m.

<a href="/media/histo_time_gender.png"><img src="/media/histo_time_gender.png" onmouseover="this.src='/media/histo_time_gender_2.png'" onmouseout="this.src='/media/histo_time_gender.png'" class="center"  width='75%'/></a>

Interestingly, the women distribution is close to a Gaussian (similar values around the peak on both sides). Now, male runners faster than 5h seem to be able to squeeze better times than females of same age. The difference is highest just below 4h. I know this time is kind of a mental goal for many runners. However, after 5 hours, both genders decay in the same manner, with women always slightly better then men.


**What about time AND age, by gender?**

Combining both histograms one can plot a Scatter plot where the horizontal is Age and vertical is Finishing time. Different color for males and females.

<a href="/media/scatter.png"><img src="/media/scatter.png" onmouseover="this.src='/media/scatter-4.png'" onmouseout="this.src='/media/scatter.png'" class="center"  width='75%'/></a>

Both gender show a similar distribution, quite broad both in Age and Time. That means nither of them is significative of the other. Youngsters can be slow, and  seniors fast. There is a slight convergence towards more time as age increases. There seems to be a slight slope of less than 1 hour every 20 years for the best runners. I think the course closed after 7 hours, hence the flat upper boundary.

However, there is blue edge on the fast side, all across ages. Faster men tend to be faster then women of the same age, specially between 30 and 60 years old.

By the way, I am flabbergasted by the right side of the scatter, runners above 60 running on the same time bands than people 40 years younger. **Respect**!

**Pacing yourself**

One can also plot the **Excess time**. This is the difference between twice the *half-marathon* time and the total time. If you keep a constant pace, this *Excess time* will be 0. If you *hit the wall* on the second half and need 1 hour more to finish, then your *Excess time* will be 1. I am plotting this against Age, to see how it  depends on the age, and also with different colors for men and women:
	
<a href="/media/histo_Excess_time_gender.png"><img src="/media/histo_Excess_time_gender.png" onmouseover="this.src='/media/histo_Excess_time_gender-over.png'" onmouseout="this.src='/media/histo_Excess_time_gender.png'" class="center"  width='75%'/></a>

As the figure shows, very few people are actually *faster* on the second half (means to the left of the vertical line above 0). Above 60 everyone is slower on the second half.

The graph is pretty much a packed vertical shape, but some convergence on the top. Older runners seem to be able to keep their pace better, specially women.

Again you can see a blue edge across all ages, mostly men that need more than one hour on the second half. I would say they "[hit the wall](http://en.wikipedia.org/wiki/Hitting_the_wall)" hard. In that sense, seems men hit the wall more than women, specially young runners below 60.


**Mapping the clusters of runners**

For the next visualization, I wanted to map all runners on the US map. You can indeed upload the csv file to [Google Fusion Tables](http://www.google.com/drive/start/apps.html#fusiontables) (the file is [too big](http://support.google.com/drive/bin/answer.py?hl=en&answer=37603) for [Google Docs](https://docs.google.com)), and Google will recognize the Location names and map then for you. Pretty awesome, quick, and easy.

[Google maps]

There are several problems here. For once, I want to have some control to make the map more beautiful and customize the looks (and I dig open source). Above all, any place with more than one runner will simply overlap everyone on the same place. I need to aggregate the data.

To aggregate the data I use again Python, and this little code:

    #Get a list of cities
    #Count uniques
    from collections import Counter
    Places=[r['Location'] for r in runner if 'Location' in r]
    Places_counts = Counter(Places)
    len(Places_counts)
    Places_counts.most_common(10)
    #Make a dictionary with Places, their location, and number of runners
    Places_dic={}

    from collections import Counter
    #runner is the list with every runner a dictionary
    Places=[r['Location'] for r in runner if 'Location' in r]
    Places_counts = Counter(Places)
    for r in runner:
     for P in Places_counts:
	
	 if r['Location']==P:  #runner is from that place
		if P in Places_dic:
		  #not the first time, add info to this location
		  Places_dic[P]['runners']+=1
		  Places_dic[P]['Time'].append(int(r['ChipTimeSeconds']))
		  Places_dic[P]['Ages'].append(int(r['Age']))
		  Places_dic[P]['Gender'].append(r['Sex'])
		  if Places_dic[P]['lat']=='':
			Places_dic[P]['lat']=r['lat']
			print 'gotcha'
		  if Places_dic[P]['lng']=='':
			Places_dic[P]['lng']=r['lat']
			print 'gotcha'
		else:
		  #first time, add dictionary
		  Places_dic[P]={}
		  Places_dic[P]['runners']=1
		  Places_dic[P]['Time']=[int(r['ChipTimeSeconds'])]
		  Places_dic[P]['Ages']=[int(r['Age'])]
		  Places_dic[P]['Gender']=[r['Sex']]
		  Places_dic[P]['lat']=r['lat']
		  Places_dic[P]['lng']=r['lng']
		  print 'new place:',P

With a little bit of some more python magic, you can aggregate the Times and Ages to get the percentiles, and save everything to a neat csv file with all the info you need. You can see the whole [python code here](https://gist.github.com/3996931).

Now you can go to TileMill, import the file on a new project and have the map styled, up and running in less than 10 minutes.

<a href="/media/tilemill-mcm.png"><img src="/media/tilemill-mcm.png" onmouseover="this.src='/media/tilemill-mcm-over.png'" onmouseout="this.src='/media/tilemill-mcm.png'" class="center"  width='75%'/></a>

and this is the result, pan and zoom at will ([Full Screen here](http://a.tiles.mapbox.com/v3/brunosan.map-usc1zz4y.html#5.00/39.711/-86.018))
<iframe width='100%' height='600' frameBorder='0' src='http://a.tiles.mapbox.com/v3/brunosan.map-usc1zz4y.html#5/38.880209498082706/-77.11475372314449'></iframe>

There are surely many more things one can do, but I leave the train here. It has been an amazing experience. I enjoyed the training. Running the marathon was a challenge but not a suffering and I really enjoyed doing it. Playing around with this data has also been very fun!

Ideas? Comments? Thanks!!
